name: Gemmini CI
on: [push]
jobs:
  install-esp-toolchain:
    name: install-esp-toolchain
    runs-on: ubuntu-latest
    container:
      image: ucbbar/chipyard-ci-image:554b436
      options: --entrypoint /bin/bash
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: generate-keys
        id: genkey
        run: |
          echo "::set-output name=install-esp-toolchain-cache-key::esp-tools-${{ github.ref }}-${{ github.sha }}"
      - name: cache
        uses: actions/cache@v2
        with:
          path: /home/riscvuser/esp-tools-install
          key: ${{ steps.genkey.outputs.install-esp-toolchain-cache-key }}
          restore-keys: ${{ steps.genkey.outputs.install-esp-toolchain-cache-key }}
      - name: toolchain-build
        run: .github/scripts/build-toolchains.sh esp-tools

  prepare-build-environment:
    name: prepare-build-environment
    runs-on: ubuntu-latest
    container:
      image: ucbbar/chipyard-ci-image:554b436
      options: --entrypoint /bin/bash
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: generate-keys
        id: genkey
        run: |
          echo "::set-output name=prepare-build-environment-cache-key::build-environment-${{ github.ref }}-${{ github.sha }}"
      - name: cache
        uses: actions/cache@v2
        with:
          path: /home/riscvuser/chipyard
          key: ${{ steps.genkey.outputs.prepare-build-environment-cache-key }}
          restore-keys: ${{ steps.genkey.outputs.prepare-build-environment-cache-key }}
      - name: setup build environment
        run: .github/scripts/prepare-for-rtl-build.sh
      - name: intall verilator
        run: .github/scripts/install-verilator.sh
